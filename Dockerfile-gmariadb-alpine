# $Id: Dockerfile-gmariadb-alpine 397 2021-06-21 14:05:24Z bpahlawa $
# $Author: bpahlawa $
# Created: 26-APR-2021
# Modified by: bpahlawa
# $Date: 2021-06-21 22:05:24 +0800 (Mon, 21 Jun 2021) $
# $Revision: 397 $
#
# How to run the docker image
# for single node:
# Rebuild DBCONFIG
# docker run -it --name galera-mariadb --network host -v /opt/mariadb:/var/lib/mysql -v /opt/mariadb/conf:/etc/my.cnf.d -e MARIADB_DBCONFIG_REBUILD=yes galera-mariadb
#
# Rebuild DBCONFIG and Database
# docker run -it --name galera-mariadb --network host -v /opt/mariadb:/var/lib/mysql -v /opt/mariadb/conf:/etc/my.cnf.d -e MARIADB_DBCONFIG_REBUILD=yes MARIADB_DATABASE_REBUILD=yes galera-mariadb
#
# Run without Rebuild
# docker run -it --name galera-mariadb --network host -v /opt/mariadb:/var/lib/mysql -v /opt/mariadb/conf:/etc/my.cnf.d galera-mariadb
#
# or
#
# Rebuild DBCONFIG and DATABASE
# docker run -it --name galera-mariadb --network host -v /opt/mariadb:/var/lib/mysql -v /opt/mariadb/conf:/etc/my.cnf.d -e MARIADB_DBCONFIG_REBUILD=yes -e MARIADB_DATABASE_REBUILD=yes galera-mariadb
#
#
# for donor node:
# Rebuild DBCONFIG with HOST network
# docker run -it --name galera-mariadb  --network host -v /opt/mariadb:/var/lib/mysql -v /opt/mariadb/conf:/etc/my.cnf.d -e GALERA_CLUSTER_ACTIVE=yes -e MARIADB_DBCONFIG_REBUILD=yes galera-mariadb
#
# Rebuild DBCONFIG and Database
# docker run -it --name galera-mariadb  --network host -v /opt/mariadb:/var/lib/mysql -v /opt/mariadb/conf:/etc/my.cnf.d -e GALERA_CLUSTER_ACTIVE=yes -e MARIADB_DBCONFIG_REBUILD=yes -e MARIADB_DATABASE_REBUILD=yes galera-mariadb
#
# Run without Rebuild with HOST network
# docker run -it --name galera-mariadb  --network host -v /opt/mariadb:/var/lib/mysql -v /opt/mariadb/conf:/etc/my.cnf.d -e GALERA_CLUSTER_ACTIVE=yes galera-mariadb
#
# for joiner node:
# Rebuild DBCONFIG and DATABASE with HOST network
# docker run -it --name galera-mariadb  --network host -v /opt/mariadb:/var/lib/mysql -v /opt/mariadb/conf:/etc/my.cnf.d -e MARIADB_DBCONFIG_REBUILD=yes -e MARIADB_DATABASE_REBUILD=yes -e GALERA_CLUSTER_ADDRESS="gcomm://192.168.0.158" galera-mariadb
#
# Run without Rebuild DBCONFIG and DATABASE with HOST network
# docker run -it --name galera-mariadb  --network host -v /opt/mariadb:/var/lib/mysql -v /opt/mariadb/conf:/etc/my.cnf.d -e GALERA_CLUSTER_ADDRESS="gcomm://192.168.0.158" galera-mariadb
#
# add entrypoint.sh in base64 to Dockerfile
# echo -e "RUN echo \"$(cat gmariadb.env | base64 -w0)\" | base64 -d > /usr/local/bin/gmariadb.env\nRUN chmod ugo+x /usr/local/bin/gmariadb.env" >> Dockerfile-gmariadb-alpine
# echo -e "RUN echo \"$(cat entrypoint-gmariadb.sh | base64 -w0)\" | base64 -d > /usr/local/bin/entrypoint-gmariadb.sh\nRUN chmod ugo+x /usr/local/bin/entrypoint-gmariadb.sh\nENTRYPOINT [\"/usr/local/bin/entrypoint-gmariadb.sh\"]" >> Dockerfile-gmariadb-alpine
#
# where:
# /opt/mariadb (on Host)      is mapped to /var/lib/mysql (on Container)
# /opt/mariadb/conf (on Host) is mapped to /etc/my.cnf.d (on Container)
# /opt/web                    is mapped to Apache2 dir
# /opt/web/main               is mapped to Apache2 document root
# MARIADB_DBCONFIG_REBUILD=yes (re-create /etc/my.cnf.d/server.cnf
# MARIADB_DATABASE_REBUILD=yes (destroy and re-create database under directory /var/lib/mysql/data )
# --network host (it uses host network, NOTE: galera must use network host if it requires to have multimaster replication on a different node)
#
# NOTE: for all default environment variable please check galera.env file
#
# How to build this Dockerfile
# Run the following command where Dockerfile exists
#
# docker build --tag galera-mariadb .
# docker build --tag galera-mariadb -f ./Dockerfile-gmariadb-alpine /mnt

FROM jsimonetti/alpine-edge:latest
MAINTAINER brpahlaw

WORKDIR /usr/local/bin
VOLUME /var/lib/mysql /etc/my.cnf.d
RUN apk update
RUN apk upgrade
RUN echo "https://dl-cdn.alpinelinux.org/alpine/edge/testing" >> /etc/apk/repositories
RUN apk add bash which socat galera mariadb-client mariadb-backup procps iproute2
RUN ln -s /usr/lib/mariadb /usr/lib/mysql
RUN echo "IyEvYmluL2Jhc2gKIyAkSWQ6IGdtYXJpYWRiLmVudiAzOTYgMjAyMS0wNi0yMSAxMDo1Nzo1NFogYnBhaGxhd2EgJAojIENyZWF0ZWQgMTktQVBSLTIwMjEKIyAkQXV0aG9yOiBicGFobGF3YSAkCiMgJERhdGU6IDIwMjEtMDYtMjEgMTg6NTc6NTQgKzA4MDAgKE1vbiwgMjEgSnVuIDIwMjEpICQKIyAkUmV2aXNpb246IDM5NiAkCgoKZXhwb3J0IE1BUklBREJfREFUQUJBU0VfUkVCVUlMRD0ke01BUklBREJfREFUQUJBU0VfUkVCVUlMRDotbm99CmV4cG9ydCBNQVJJQURCX0RCQ09ORklHX1JFQlVJTEQ9JHtNQVJJQURCX0RCQ09ORklHX1JFQlVJTEQ6LW5vfQpleHBvcnQgR0FMRVJBX0NMVVNURVJfTkFNRT0ke0dBTEVSQV9DTFVTVEVSX05BTUU6LW15Y2x1c3Rlcn0KZXhwb3J0IEdBTEVSQV9DTFVTVEVSX0JPT1RTVFJBUD0ke0dBTEVSQV9DTFVTVEVSX0JPT1RTVFJBUDotbm99CmV4cG9ydCBHQUxFUkFfQ0xVU1RFUl9BRERSRVNTPSR7R0FMRVJBX0NMVVNURVJfQUREUkVTUzotImdjb21tOi8vIn0KZXhwb3J0IFVTRV9DT05UQUlORVJfQUREUkVTUz0ke1VTRV9DT05UQUlORVJfQUREUkVTUzoteWVzfQpleHBvcnQgR0FMRVJBX0RFRkFVTFRfTk9ERU5BTUU9JHtHQUxFUkFfREVGQVVMVF9OT0RFTkFNRTotJChob3N0bmFtZSAtcyl9CmV4cG9ydCBHQUxFUkFfREVGQVVMVF9BRERSRVNTPSR7R0FMRVJBX0RFRkFVTFRfQUREUkVTUzotJChob3N0bmFtZSAtaSB8IGF3ayAne3ByaW50ICQxfScpfQpleHBvcnQgJHtNQVJJQURCX1JPT1RfUEFTU1dPUkR9CmV4cG9ydCBNQVJJQURCX0RBVEFCQVNFX05BTUU9JHtNQVJJQURCX0RBVEFCQVNFX05BTUU6LW15ZGJ9CmV4cG9ydCBNQVJJQURCX0RBVEFCQVNFX1VTRVI9JHtNQVJJQURCX0RBVEFCQVNFX1VTRVI6LWFkbWlufQpleHBvcnQgTUFSSUFEQl9EQVRBQkFTRV9VU0VSUEFTUz0ke01BUklBREJfREFUQUJBU0VfVVNFUlBBU1M6LXBhc3N3b3JkfQpleHBvcnQgTUFSSUFEQl9SRVBMSUNBVElPTl9VU0VSPSR7TUFSSUFEQl9SRVBMSUNBVElPTl9VU0VSOi1yZXBsdXNlcn0KZXhwb3J0IE1BUklBREJfUkVQTElDQVRJT05fVVNFUlBBU1M9JHtNQVJJQURCX1JFUExJQ0FUSU9OX1VTRVJQQVNTOi1wYXNzd29yZH0KZXhwb3J0IE1BUklBREJfQkFTRV9ESVI9JHtNQVJJQURCX0JBU0VfRElSOi0vdmFyL2xpYi9teXNxbH0KZXhwb3J0IEdBTEVSQV9CT09UU1RSQVBfRElSPSIke01BUklBREJfQkFTRV9ESVJ9Ly5ib290c3RyYXAiCmV4cG9ydCBHQUxFUkFfQk9PVFNUUkFQX0ZJTEU9IiR7R0FMRVJBX0JPT1RTVFJBUF9ESVJ9L2RvbmUiCmV4cG9ydCBNQVJJQURCX0RBVEFCQVNFX0RJUj0ke01BUklBREJfREFUQUJBU0VfRElSOi0ke01BUklBREJfQkFTRV9ESVJ9L2RhdGF9CmV4cG9ydCBNQVJJQURCX0RFRkFVTFRfUE9SVD0ke01BUklBREJfREVGQVVMVF9QT1JUOi0zMzA2fQpleHBvcnQgTUFSSUFEQl9URU1QX0RJUj0ke01BUklBREJfVEVNUF9ESVI6LSR7TUFSSUFEQl9CQVNFX0RJUn0vdG1wfQpleHBvcnQgTUFSSUFEQl9TT0NLRVRfRklMRT0ke01BUklBREJfU09DS0VUX0ZJTEU6LSR7TUFSSUFEQl9URU1QX0RJUn0vbXlzcWwuc29ja30KZXhwb3J0IE1BUklBREJfUElEX0ZJTEU9JHtNQVJJQURCX1BJRF9GSUxFOi0ke01BUklBREJfVEVNUF9ESVJ9L215c3FsZC5waWR9CmV4cG9ydCBNQVJJQURCX0JJTkRfQUREUkVTUz0ke01BUklBREJfQklORF9BRERSRVNTOi0wLjAuMC4wfQpleHBvcnQgTUFSSUFEQl9MT0dTX0RJUj0ke01BUklBREJfTE9HU19ESVI6LSR7TUFSSUFEQl9CQVNFX0RJUn0vbG9nc30KZXhwb3J0IE1BUklBREJfREVGQVVMVF9DSEFSU0VUPSR7TUFSSUFEQl9ERUZBVUxUX0NIQVJTRVQ6LXV0Zjh9CmV4cG9ydCBNQVJJQURCX0RFRkFVTFRfQ09MTEFURT0ke01BUklBREJfREVGQVVMVF9DT0xMQVRFOi11dGY4X2dlbmVyYWxfY2l9CmV4cG9ydCBNQVJJQURCX1BMVUdJTl9ESVI9JHtNQVJJQURCX1BMVUdJTl9ESVI6LSR7TUFSSUFEQl9CQVNFX0RJUn0vcGx1Z2lufQpleHBvcnQgTUFSSUFEQl9CQUNLVVBfVVNFUj0ke01BUklBREJfQkFDS1VQX1VTRVI6LSJtYXJpYWJrcHVzZXIifQpleHBvcnQgTUFSSUFEQl9CQUNLVVBfVVNFUlBBU1M9JHtNQVJJQURCX0JBQ0tVUF9VU0VSUEFTUzotInBhc3N3b3JkIn0KZXhwb3J0IE1BUklBREJfU1NUX01FVEhPRD0ke01BUklBREJfU1NUX01FVEhPRDotIm1hcmlhYmFja3VwIn0K" | base64 -d > /usr/local/bin/gmariadb.env
RUN chmod ugo+x /usr/local/bin/gmariadb.env
RUN echo "IyEvYmluL2Jhc2gKIyAkSWQ6IGVudHJ5cG9pbnQtZ21hcmlhZGIuc2ggMzk2IDIwMjEtMDYtMjEgMTA6NTc6NTRaIGJwYWhsYXdhICQKIyBDcmVhdGVkIDE5LUFQUi0yMDIxCiMgJEF1dGhvcjogYnBhaGxhd2EgJAojICREYXRlOiAyMDIxLTA2LTIxIDE4OjU3OjU0ICswODAwIChNb24sIDIxIEp1biAyMDIxKSAkCiMgJFJldmlzaW9uOiAzOTYgJAoKCnNvdXJjZSAuL2dtYXJpYWRiLmVudgoKIyBVc2VyIHNwZWNpZmljIGVudmlyb25tZW50IGFuZCBzdGFydHVwIHByb2dyYW1zClJFREZPTlQ9IlxlWzM4OzU7MTk3bSIKR1JFRU5GT05UPSJcZVszODs1OzgybSIKTk9STUFMRk9OVD0iXGVbMG0iCkJMVUVGT05UPSJcZVszODs1OzEyM20iCllFTExPV0ZPTlQ9IlxlWzM4OzU7MjI5bSIKVkVSU0lPTl9JRD0iIgpBTExWRVI9IiIKZXhwb3J0IERJU1RSTz0iIgpQS0dESVNUUk89IiIKUlVOUEtHVVBEQVRFPSIxIgpMT0dGSUxFPS90bXAvJChiYXNlbmFtZSAkMCB8IGN1dCAtZjEgLWQuKS5sb2cKREJVU0VSPSJteXNxbCIKCklOSUZJTEU9Ii9ldGMvbXkuY25mLmQvc2VydmVyLmNuZiIKCnRyYXAgZXhpdHNoZWxsIFNJR0lOVCBTSUdURVJNCgpkYXRlID4gJExPR0ZJTEUKCmNoZWNraW5nX3JlcWRfdG9vbHMoKQp7CiAgIHdoaWNoIC0tdmVyc2lvbiAyPi9kZXYvbnVsbCAxPi9kZXYvbnVsbAogICBbWyAkPyAtbmUgMCBdXSAmJiBkaXNwbGF5X291dHB1dCAiJHtSRURGT05UfXdoaWNoIGNvbW1hbmQgZG9lc250IGV4aXN0LCBwbGVhc2UgaW5zdGFsbCBpdC4uLiIgJiYgZXhpdAogICBzb2NhdCAtViAyPi9kZXYvbnVsbCAxPi9kZXYvbnVsbAogICBbWyAkPyAtbmUgMCBdXSAmJiBkaXNwbGF5X291dHB1dCAiJHtSRURGT05UfXNvY2F0IGNvbW1hbmQgZG9lc250IGV4aXN0LCBwbGVhc2UgaW5zdGFsbCBpdC4uLiIgJiYgZXhpdAp9CgpnZXRfYWxsX3NlY3Rpb25zKCkKewogICBzZWQgLW4gJ3MvXlsgXHRdKlxbXCguKlwpXF0uKi9cMS9wJyAiJElOSUZJTEUiCn0KCmdldF92YWx1ZSgpCnsKICAgbG9jYWwgU0VDVElPTj0iJDEiCiAgIGxvY2FsIEtFWT0iJDIiCiAgIFtbICIkS0VZIiA9ICIiIHx8ICIkU0VDVElPTiIgPSAiIiBdXSAmJiBkaXNwbGF5X291dHB1dCAiJHtSRURGT05UfVNFQ1RJT04gYW5kIEtFWSBtdXN0IGJlIHNwZWNpZmllZCEhIiAmJiByZXR1cm4KICAgc2VkIC1uICIvXlsgXHRdKlxbJFNFQ1RJT05cXS8sL1xbL3MvXlsgXHRdKiRLRVlbIFx0XSo9WyBcdF0qLy9wIiAiJElOSUZJTEUiIDI+L2Rldi9udWxsCn0KCgpydW5fY2x1c3RlcigpCnsKICAgaWYgWyAiJEdBTEVSQV9DTFVTVEVSX0JPT1RTVFJBUCIgPSAieWVzIiBdCiAgIHRoZW4KICAgICAgR0FMRVJBX0NMVVNURVJfQUREUkVTUz0iZ2NvbW06Ly8iCiAgICAgIGlmIFsgLWYgJE1BUklBREJfREFUQUJBU0VfRElSL2dyYXN0YXRlLmRhdCBdCiAgICAgIHRoZW4KICAgICAgICAgIHNlZCAtaSAic3xeXChzYWZlX3RvX2Jvb3RzdHJhcDouKlwpMC4qfFwxMXxnIiAiJE1BUklBREJfREFUQUJBU0VfRElSL2dyYXN0YXRlLmRhdCIgICAgICAgICAKICAgICAgZmkKICAgZmkKfQoKc2h1dGRvd25fdG1wX215c3FsKCkKewogICBteXNxbGFkbWluIC11IHJvb3Qgc2h1dGRvd24KICAgd2hpbGUgW1sgJChpc19teXNxbF9ydW5uaW5nKSAtZXEgMCBdXQogICBkbwogICAgICBzbGVlcCAzCiAgIGRvbmUKfQoKCmdldF9rZXl2YWx1ZSgpCnsKICAgbG9jYWwgU0VDVElPTj0iJDEiCiAgIFtbICIkU0VDVElPTiIgPSAiIiBdXSAmJiBkaXNwbGF5X291dHB1dCAiJHtSRURGT05UfVNFQ1RJT04gbXVzdCBiZSBzcGVjaWZpZWQhISIgJiYgcmV0dXJuCiAgIHNlZCAtbiAiL15bIFx0XSpcWyRTRUNUSU9OXF0vLC9cWy9zL15bIFx0XSpcKFteIzsgXHRdW14gXHQ9XSpcKS4qPVsgXHRdKlwoLipcKS9cMT1cMi9wIiAiJElOSUZJTEUiIDI+L2Rldi9udWxsCn0KCnNldF92YWx1ZSgpCnsKICAgbG9jYWwgU0VDVElPTj0iJDEiCiAgIGxvY2FsIEtFWT0iJDIiCiAgIGxvY2FsIE5FV1ZBTD0iJDMiCiAgIFtbICIkS0VZIiA9ICIiIHx8ICIkU0VDVElPTiIgPSAiIiB8fCAiJE5FV1ZBTCIgPSAiIiBdXSAmJiBkaXNwbGF5X291dHB1dCAiJHtSRURGT05UfVNFQ1RJT04sIEtFWSBhbmQgTkVXVkFMIG11c3QgYmUgc3BlY2lmaWVkISEiICYmIHJldHVybgogICBPTERLRVlWQUw9JChnZXRfa2V5dmFsdWUgIiRTRUNUSU9OIiB8IGdyZXAgIl4ke0tFWX1bXHNdKj0uKiIgKQogICBbWyAiJE9MREtFWVZBTCIgPSAiIiBdXSAmJiBkaXNwbGF5X291dHB1dCAiJHtSRURGT05UfVNlY3Rpb24gJFNFQ1RJT04gd2l0aCBLZXl2YWx1ZSAkT0xES0VZVkFMIGlzIG5vdCBhdmFpbGFibGUsIHRoZXJlZm9yZSB2YWx1ZSBjYW4gbm90IGJlIGNoYW5nZWQhISIgJiYgcmV0dXJuCiAgIExOTzJSRVBMQz0kKGdyZXAgLW4gIl4ke0tFWX1bXHNdKj0uKiIgIiRJTklGSUxFIiB8IGN1dCAtZjEgLWQiOiIpCiAgIE5FV0tFWVZBTD0kKCBlY2hvICIkT0xES0VZVkFMIiB8IHNlZCAicy9cKF4kS0VZLio9XCkuKi9cMSRORVdWQUwvIikKICAgaWYgW1sgIiRPTERLRVlWQUwiICE9ICIiICYmICIkTkVXS0VZVkFMIiAhPSAiIiBdXQogICB0aGVuCiAgICAgIHNlZCAtaSAiJHtMTk8yUkVQTEN9cy8uKi8kTkVXS0VZVkFMLyIgIiRJTklGSUxFIgogICAgICBbWyAkPyAtZXEgMCBdXSAmJiBkaXNwbGF5X291dHB1dCAiJHtHUkVFTkZPTlR9U2VjdGlvbiAkU0VDVElPTiBsaW5lICRPTERLRVlWQUwgYXQgbGluZSMgJExOTzJSRVBMQyBoYXMgYmVlbiByZXBsYWNlZCB3aXRoICRORVdLRVlWQUwiCiAgIGVsc2UKICAgICAgZGlzcGxheV9vdXRwdXQgIiR7UkVERk9OVH1laXRoZXIgb2xkIGtleXZhbHVlIG9yIG5ldyBrZXl2YWx1ZSBpcyBlbXB0eSEhXG5vbGQga2V5dmFsdWUgPSAkT0xES0VZVkFMIFxubmV3IGtleXZhbHVlID0gJE5FV0tFWVZBTCIKICAgZmkKfQoKYWRkX2tleXZhbHVlKCkKewogIGxvY2FsIFNFQ1RJT049IiQxIgogIGxvY2FsIEtFWVZBTD0iJDIiCiAgbG9jYWwgQUZURVJLRVk9IiQzIgogIFtbICIkU0VDVElPTiIgPSAiIiB8fCAiJEtFWVZBTCIgPSAiIiBdXSAmJiBkaXNwbGF5X291dHB1dCAiJHtSRURGT05UfVNFQ1RJT04gYW5kIG5ldyBLZXl2YWx1ZSBtdXN0IGJlIHNwZWNpZmllZCEhIiAmJiByZXR1cm4KICBMTk9TRUNUSU9OPSQoZ3JlcCAtbiAiXlxbJHtTRUNUSU9OfVxdLioiICIkSU5JRklMRSIgfCBjdXQgLWYxIC1kIjoiKQogIGlmIFsgIiRBRlRFUktFWSIgIT0gIiIgXQogIHRoZW4KICAgICBMTk8yTUFSSz0kKGdyZXAgLW4gIl4ke0FGVEVSS0VZfVtcc10qPS4qIiAiJElOSUZJTEUiIHwgY3V0IC1mMSAtZCI6IikKICBlbHNlCiAgICAgTE5PMk1BUks9IiRMTk9TRUNUSU9OIgogIGZpCiAgW1sgJExOTzJNQVJLIC1sdCAkTE5PU0VDVElPTiAmJiAkTE5PMk1BUksgLWx0IDEgXV0gJiYgZGlzcGxheV9vdXRwdXQgIiR7UkVERk9OVH1UaGVyZSBhcmUgZHVwbGljYXRlIGtleXMuLiIgJiYgcmV0dXJuCiAgc2VkIC1pICIkTE5PMk1BUksgYSAkS0VZVkFMIiAiJElOSUZJTEUiCiAgW1sgJD8gLWVxIDAgXV0gJiYgZGlzcGxheV9vdXRwdXQgIiR7R1JFRU5GT05UfUtleXZhbHVlICRLRVlWQUwgaGFzIGJlZW4gc3VjY2Vzc2Z1bGx5IGFkZGVkIGludG8gU2VjdGlvbiAkU0VDVElPTiBhdCBsaW5lIyAkKCggTE5PMk1BUksgKyAxICkpIgp9CgoKZXhpdHNoZWxsKCkKewogICBkaXNwbGF5X291dHB1dCAiJHtOT1JNQUxGT05UfUNhbmNlbGxpbmcgc2NyaXB0Li4uLmV4aXRpbmcuLi4uLiIKICAgW1sgISAtZCAiJE1BUklBREJfREFUQUJBU0VfRElSL215c3FsIiAmJiAtZCAkTUFSSUFEQl9EQVRBQkFTRV9ESVIgJiYgIiRNQVJJQURCX0RBVEFCQVNFX0RJUiIgIT0gIi8iIF1dICYmIGRpc3BsYXlfb3V0cHV0ICIke0dSRUVORk9OVH1SZW1vdmluZyBkaXJlY3RvcnkgJE1BUklBREJfREFUQUJBU0VfRElSIiAmJiBybSAtcmYgJE1BUklBREJfREFUQUJBU0VfRElSCiAgIFtbIC1mICRNQVJJQURCX0xPR1NfRElSL215c3FsZC5sb2cgXV0gJiYgZGlzcGxheV9vdXRwdXQgIiR7R1JFRU5GT05UfVJlbW92aW5nIG1hcmlhZGIgbG9nIGZpbGUgJE1BUklBREJfTE9HU19ESVIvbXlzcWxkLmxvZyIgJiYgcm0gLWYgJE1BUklBREJfTE9HU19ESVIvbXlzcWxkLmxvZwogICBleGl0IDAKfQoKCmRpc3BsYXlfb3V0cHV0KCkKewogICBsb2NhbCBNRVNTQUdFPSIkMSIKICAgbG9jYWwgSElERT0iJDIiCgogICBbWyAiJEhJREUiID0gIjEiIHx8ICIkSElERSIgPSAiIiBdXSAmJiBlY2hvIC1lICIkTUVTU0FHRSR7Tk9STUFMRk9OVH0iCiAgIFtbICIkSElERSIgPSAiMiIgfHwgIiRISURFIiA9ICIiIF1dICYmIGVjaG8gLWUgIiRNRVNTQUdFIiB8IHNlZCAtciAicy9bWzpjbnRybDpdXVxbKFswLTldezEsM307KSpbMC05XXsxLDN9bS8vZyIgPj4gJExPR0ZJTEUKfQoKaW5zdGFsbF9tYXN0ZXJfZGIoKQp7CiAgW1sgIiRNQVJJQURCX0RBVEFCQVNFX0RJUiIgPSAiIiBdXSAmJiBleHBvcnQgTUFSSUFEQl9EQVRBQkFTRV9ESVI9L3Zhci9saWIvbXlzcWwvZGF0YQoKICBkaXNwbGF5X291dHB1dCAiJHtZRUxMT1dGT05UfUNoZWNraW5nIHdoZXRoZXIgZGVmYXVsdCBkYXRhYmFzZSBvbiBkaXJlY3RvcnkgJE1BUklBREJfREFUQUJBU0VfRElSIC4uLiIKICBbWyAtZCAiJE1BUklBREJfREFUQUJBU0VfRElSIiBdXSAmJiBkaXNwbGF5X291dHB1dCAiJHtHUkVFTkZPTlR9UmVtb3ZpbmcgZGlyZWN0b3J5ICRNQVJJQURCX0RBVEFCQVNFX0RJUiAuLi4iICYmIHJtIC1yZiAkTUFSSUFEQl9EQVRBQkFTRV9ESVIKICBkaXNwbGF5X291dHB1dCAiJHtHUkVFTkZPTlR9Q3JlYXRpbmcgaW5pdGlhbCBkYXRhYmFzZSBvbiBkaXJlY3RvcnkgJHtCTFVFRk9OVH0kTUFSSUFEQl9EQVRBQkFTRV9ESVIiCiAgbXlzcWxfaW5zdGFsbF9kYiAtLXVzZXI9JERCVVNFUiAtLWxkYXRhPSIkTUFSSUFEQl9EQVRBQkFTRV9ESVIiIC0tc2tpcC10ZXN0LWRiCn0KCgpydW5fbXlzcWxfY21kKCkKewogIFRIRUNNRD0iJDEiCiAgbXlzcWwgLXUgcm9vdCA8PCEKJFRIRUNNRAohCgogIGlmIFsgJD8gLW5lIDAgXQogIHRoZW4KICAgICBkaXNwbGF5X291dHB1dCAiJHtSRURGT05UfUZhaWxlZCB0byBleGVjdXRlIHRoZSBsYXN0IFN0YXRlbWVudCEhIgogIGVsc2UKICAgICBkaXNwbGF5X291dHB1dCAiJHtCTFVFRk9OVH1TdGF0ZW1lbnQgZXhlY3V0ZWQgc3VjY2Vzc2Z1bGx5IgogIGZpCiAgICAgICAgIAp9CgpnZXRfcGlkKCkgewogICAgbG9jYWwgUElERklMRT0iJHsxOj9waWQgZmlsZSBpcyBtaXNzaW5nfSIKCiAgICBpZiBbIC1mICIkUElERklMRSIgXTsgdGhlbgogICAgICAgZWNobyAkKGNhdCAkUElERklMRSAyPi9kZXYvbnVsbCkKICAgIGZpCn0KCmlzX2RiX3J1bm5pbmcoKSB7CiAgICBsb2NhbCBQSUQ9IiR7MTo/cGlkIGlzIG1pc3Npbmd9IgogICAga2lsbCAtMCAiJFBJRCIgMj4vZGV2L251bGwKICAgIGVjaG8gJD8KfQoKCmlzX215c3FsX3J1bm5pbmcoKQp7CiAgICBsb2NhbCBQSUQKICAgIFBJRD0iJChnZXRfcGlkICIkTUFSSUFEQl9QSURfRklMRSIpIgogICAgaWYgW1sgLXogIiRQSUQiIF1dOyB0aGVuCiAgICAgICBlY2hvIDEKICAgIGVsc2UKICAgICAgIGVjaG8gJChpc19kYl9ydW5uaW5nICIkUElEIikKICAgIGZpCn0KCgppc19teXNxbF9hY2Nlc3NpYmxlKCkKewogICBteXNxbCAtdSByb290IDw8ISAyPi9kZXYvbnVsbApzZWxlY3QgdXNlcigpOwohCgpbWyAkPyAtbmUgMCBdXSAmJiBlY2hvICJOT1QgUlVOTklORyIKfQoKCnJ1bl9teXNxbF90ZW1wX2JnKCkKewogICAgRkxBR1M9Ii0tdXNlcj0kREJVU0VSIC0tYmluZC1hZGRyZXNzPTEyNy4wLjAuMSAtLXNraXAtc2xhdmUtc3RhcnQiCgogICAgW1sgJChpc19teXNxbF9ydW5uaW5nKSAtZXEgMCBdXSAmJiByZXR1cm4KCiAgICBkaXNwbGF5X291dHB1dCAiJHtHUkVFTkZPTlR9U3RhcnRpbmcgbWFyaWFkYiBpbiBiYWNrZ3JvdW5kIgogICAgbXlzcWxkICRGTEFHUyAmCn0KCgpjcmVhdGVfZGJfYW5kX3VzZXIoKQp7CiAgZGlzcGxheV9vdXRwdXQgIiR7R1JFRU5GT05UfUNyZWF0aW5nIERhdGFiYXNlICR7QkxVRUZPTlR9JE1BUklBREJfREFUQUJBU0VfTkFNRSIKICBydW5fbXlzcWxfY21kICJjcmVhdGUgZGF0YWJhc2UgJE1BUklBREJfREFUQUJBU0VfTkFNRSA7IiAKICBkaXNwbGF5X291dHB1dCAiJHtHUkVFTkZPTlR9Q3JlYXRpbmcgREJBIHVzZXIgJHtCTFVFRk9OVH0kTUFSSUFEQl9EQVRBQkFTRV9VU0VSJHtHUkVFTkZPTlR9IGZvciBkYXRhYmFzZSAke0JMVUVGT05UfSRNQVJJQURCX0RBVEFCQVNFX05BTUUiCiAgcnVuX215c3FsX2NtZCAiY3JlYXRlIG9yIHJlcGxhY2UgdXNlciAke01BUklBREJfREFUQUJBU0VfVVNFUn1AJyUnIElERU5USUZJRUQgQlkgJyRNQVJJQURCX0RBVEFCQVNFX1VTRVJQQVNTJzsiCiAgcnVuX215c3FsX2NtZCAiZ3JhbnQgYWxsIG9uICR7TUFSSUFEQl9EQVRBQkFTRV9OQU1FfS4qIHRvICcke01BUklBREJfREFUQUJBU0VfVVNFUn0nQCclJzsiCn0KCmNyZWF0ZV9yZXBsX3VzZXIoKQp7CiAgZGlzcGxheV9vdXRwdXQgIiR7R1JFRU5GT05UfUNyZWF0aW5nIFJlcGxpY2F0aW9uIHVzZXIgJHtCTFVFRk9OVH0kTUFSSUFEQl9SRVBMSUNBVElPTl9VU0VSIgogIHJ1bl9teXNxbF9jbWQgImNyZWF0ZSBvciByZXBsYWNlIHVzZXIgJHtNQVJJQURCX1JFUExJQ0FUSU9OX1VTRVJ9QCclJyBJREVOVElGSUVEIEJZICckTUFSSUFEQl9SRVBMSUNBVElPTl9VU0VSUEFTUyc7IgogIHJ1bl9teXNxbF9jbWQgImdyYW50IFJFUExJQ0FUSU9OIENMSUVOVCBPTiAqLiogdG8gJE1BUklBREJfUkVQTElDQVRJT05fVVNFUkAnJSc7CmdyYW50IFBST0NFU1MgT04gKi4qIHRvICRNQVJJQURCX1JFUExJQ0FUSU9OX1VTRVJAJyUnOwpmbHVzaCBwcml2aWxlZ2VzOyIKCn0KCmNyZWF0ZV9iYWNrdXBfdXNlcigpCnsKICBkaXNwbGF5X291dHB1dCAiJHtHUkVFTkZPTlR9Q3JlYXRpbmcgQmFja3VwIHVzZXIgJHtCTFVFRk9OVH0kTUFSSUFEQl9CQUNLVVBfVVNFUiIKICBydW5fbXlzcWxfY21kICJjcmVhdGUgb3IgcmVwbGFjZSB1c2VyICR7TUFSSUFEQl9CQUNLVVBfVVNFUn1AJyUnIElERU5USUZJRUQgQlkgJyRNQVJJQURCX0JBQ0tVUF9VU0VSUEFTUyc7IgogIHJ1bl9teXNxbF9jbWQgImdyYW50IFJFTE9BRCxQUk9DRVNTLExPQ0sgVEFCTEVTLFJFUExJQ0FUSU9OIENMSUVOVCBvbiAqLiogdG8gJE1BUklBREJfQkFDS1VQX1VTRVJAJyUnOwpmbHVzaCBwcml2aWxlZ2VzOyIKCn0KCgpjcmVhdGVfZGVmYXVsdF9wYXJhbWV0ZXJzKCkKewpbWyAhIC1kICIkTUFSSUFEQl9CQVNFX0RJUiIgXV0gJiYgbWtkaXIgLXAgIiRNQVJJQURCX0JBU0VfRElSIgpjaG93biAtUmggJERCVVNFUjokREJVU0VSICIkTUFSSUFEQl9CQVNFX0RJUiIKCltbICEgLWQgIiRNQVJJQURCX1RFTVBfRElSIiBdXSAmJiBzdSAtICREQlVTRVIgLXMgL2Jpbi9iYXNoIC1jICJta2RpciBcIiRNQVJJQURCX1RFTVBfRElSXCIiCltbICEgLWQgIiRNQVJJQURCX0xPR1NfRElSIiBdXSAmJiBzdSAtICREQlVTRVIgLXMgL2Jpbi9iYXNoIC1jICJta2RpciBcIiRNQVJJQURCX0xPR1NfRElSXCIiCgppZiBbICIke0dBTEVSQV9DTFVTVEVSX0FDVElWRX0iID0gInllcyIgXQp0aGVuCiAgIGlmIFsgIiR7R0FMRVJBX0NMVVNURVJfQUREUkVTU30iID0gImdjb21tOi8vIiBdCiAgIHRoZW4KICAgICAgZGlzcGxheV9vdXRwdXQgIiR7R1JFRU5GT05UfVJ1bm5pbmcgRG9ub3Igbm9kZSBvbiBnYWxlcmEgQ2x1c3RlciAkR0FMRVJBX0NMVVNURVJfTkFNRSAuLi4iCiAgIGVsc2UKICAgICAgZGlzcGxheV9vdXRwdXQgIiR7R1JFRU5GT05UfVJ1bm5pbmcgSm9pbmVyIG5vZGUgb24gZ2FsZXJhIENsdXN0ZXIgJEdBTEVSQV9DTFVTVEVSX05BTUUgLi4uIgogICBmaQplbHNlCiAgZGlzcGxheV9vdXRwdXQgIiR7R1JFRU5GT05UfVJ1bm5pbmcgc2luZ2xlIG5vZGUgTWFyaWFkYiBTZXJ2ZXIuLi4iCmZpCgoKaWYgWyAtZiAvZXRjL215LmNuZi5kLy5sb2NhbGRpciBdCnRoZW4KICAgZGlzcGxheV9vdXRwdXQgIiR7UkVERk9OVH1UaGUgZGlyZWN0b3J5IC9ldGMvbXkuY25mLmQgaXMgbm90IG1hcHBlZCB0byBwZXJzaXN0ZW50IGRpc2siCiAgIGV4aXQgMQpmaQoKW1sgLWYgJElOSUZJTEUgJiYgIiRNQVJJQURCX0RCQ09ORklHX1JFQlVJTEQiID0gIm5vIiBdXSAmJiBkaXNwbGF5X291dHB1dCAiJHtCTFVFRk9OVH1UaGUgJElOSUZJTEUgYWxyZWFkeSBleGlzdHMhIS4uLiIgJiYgcmV0dXJuCmVjaG8gIgpbbXlzcWxkXQpza2lwX2hvc3RfY2FjaGUKc2tpcF9uYW1lX3Jlc29sdmUKZXhwbGljaXRfZGVmYXVsdHNfZm9yX3RpbWVzdGFtcApiYXNlZGlyPS91c3IKZGF0YWRpcj0ke01BUklBREJfREFUQUJBU0VfRElSfQpwb3J0PSR7TUFSSUFEQl9ERUZBVUxUX1BPUlR9CnRtcGRpcj0ke01BUklBREJfVEVNUF9ESVJ9CnNvY2tldD0ke01BUklBREJfU09DS0VUX0ZJTEV9CnBpZF9maWxlPSR7TUFSSUFEQl9QSURfRklMRX0KbWF4X2FsbG93ZWRfcGFja2V0PTE2TQpiaW5kX2FkZHJlc3M9JHtNQVJJQURCX0JJTkRfQUREUkVTU30KbG9nX2Vycm9yPSR7TUFSSUFEQl9MT0dTX0RJUn0vbXlzcWxkLmxvZwpjaGFyYWN0ZXJfc2V0X3NlcnZlcj0ke01BUklBREJfREVGQVVMVF9DSEFSU0VUfQpjb2xsYXRpb25fc2VydmVyPSR7TUFSSUFEQl9ERUZBVUxUX0NPTExBVEV9CmJpbmxvZ19mb3JtYXQ9cm93CmxvZ19iaW49bXlzcWwtYmluCgpbY2xpZW50XQpwb3J0PSR7TUFSSUFEQl9ERUZBVUxUX1BPUlR9CnNvY2tldD0ke01BUklBREJfU09DS0VUX0ZJTEV9CmRlZmF1bHRfY2hhcmFjdGVyX3NldD1VVEY4CgpbbWFuYWdlcl0KcG9ydD0ke01BUklBREJfREVGQVVMVF9QT1JUfQpzb2NrZXQ9JHtNQVJJQURCX1NPQ0tFVF9GSUxFfQpwaWRfZmlsZT0ke01BUklBREJfUElEX0ZJTEV9CgpbbWFyaWFkYl0KcGx1Z2luX2xvYWRfYWRkID0gYXV0aF9wYW0KIiA+ICRJTklGSUxFCgppZiBbICIkR0FMRVJBX0NMVVNURVJfQUNUSVZFIiA9ICJ5ZXMiIF0KdGhlbgoKZWNobyAiCltnYWxlcmFdCndzcmVwX29uPU9OCndzcmVwX3Byb3ZpZGVyPS91c3IvbGliL2xpYmdhbGVyYV9zbW0uc28Kd3NyZXBfc3N0X21ldGhvZD0ke01BUklBREJfU1NUX01FVEhPRH0Kd3NyZXBfc2xhdmVfdGhyZWFkcz00CndzcmVwX2NsdXN0ZXJfYWRkcmVzcz0ke0dBTEVSQV9DTFVTVEVSX0FERFJFU1N9CndzcmVwX3NzdF9hdXRoPSR7TUFSSUFEQl9CQUNLVVBfVVNFUn06JHtNQVJJQURCX0JBQ0tVUF9VU0VSUEFTU30Kd3NyZXBfY2x1c3Rlcl9uYW1lPSR7R0FMRVJBX0NMVVNURVJfTkFNRX0Kd3NyZXBfbm9kZV9uYW1lPSR7R0FMRVJBX0RFRkFVTFRfTk9ERU5BTUV9CndzcmVwX25vZGVfYWRkcmVzcz0ke0dBTEVSQV9ERUZBVUxUX0FERFJFU1N9CgoiID4+ICRJTklGSUxFCgpmaQoKfQoKI01haW4KCnJtIC1mICR7TUFSSUFEQl9MT0dTX0RJUn0vbXlzcWxkLmxvZwpjaGVja2luZ19yZXFkX3Rvb2xzCgppZiBbWyAtZiAvLmRvY2tlcmVudiAmJiAkVVNFX0NPTlRBSU5FUl9BRERSRVNTICE9ICJ5ZXMiIF1dCnRoZW4KICAgW1sgIiRHQUxFUkFfREVGQVVMVF9OT0RFTkFNRSIgPSAiJChob3N0bmFtZSAtcykiIF1dICYmIGRpc3BsYXlfb3V0cHV0ICIke1JFREZPTlR9UnVubmluZyBvbiBkb2NrZXIgY29udGFpbmVyIEdBTEVSQV9ERUZBVUxUX05PREVOQU1FIG11c3QgYmUgc2V0IHRvIGhvc3Qgbm9kZW5hbWUiICYmIGV4aXQKICAgW1sgIiRHQUxFUkFfREVGQVVMVF9BRERSRVNTIiA9ICIkKGhvc3RuYW1lIC1pIHwgYXdrICd7cHJpbnQgJDF9JykiIF1dICYmIGRpc3BsYXlfb3V0cHV0ICIke1JFREZPTlR9UnVubmluZyBvbiBkb2NrZXIgY29udGFpbmVyIEdBTEVSQV9ERUZBVUxUX0FERFJFU1MgbXVzdCBiZSBzZXQgdG8gaG9zdCBJUCBhZGRyZXNzIiAmJiBleGl0CmVsc2UKICAgW1sgIiRHQUxFUkFfREVGQVVMVF9OT0RFTkFNRSIgIT0gIiQoaG9zdG5hbWUgLXMpIiBdXSAmJiBleHBvcnQgR0FMRVJBX0RFRkFVTFRfTk9ERU5BTUU9IiQoaG9zdG5hbWUgLXMpIgogICBbWyAiJEdBTEVSQV9ERUZBVUxUX0FERFJFU1MiICE9ICIkKGhvc3RuYW1lIC1pIHwgYXdrICd7cHJpbnQgJDF9JykiIF1dICYmIGV4cG9ydCBHQUxFUkFfREVGQVVMVF9BRERSRVNTPSIkKGhvc3RuYW1lIC1pIHwgYXdrICd7cHJpbnQgJDF9JykiCmZpCgpbWyAiJEdBTEVSQV9DTFVTVEVSX0FDVElWRSIgPSAieWVzIiBdXSAmJiBydW5fY2x1c3RlcgpjcmVhdGVfZGVmYXVsdF9wYXJhbWV0ZXJzCgpbWyAhIC1kICRNQVJJQURCX0RBVEFCQVNFX0RJUiBdXSAmJiBta2RpciAtcCAiJE1BUklBREJfREFUQUJBU0VfRElSIiAKY2hvd24gJERCVVNFUjokREJVU0VSICIkTUFSSUFEQl9EQVRBQkFTRV9ESVIiCgoKaWYgW1sgISAtZCAiJE1BUklBREJfREFUQUJBU0VfRElSL215c3FsIiB8fCAiJE1BUklBREJfREFUQUJBU0VfUkVCVUlMRCIgPSAieWVzIiBdXSAmJiBbWyAiJEdBTEVSQV9DTFVTVEVSX0FERFJFU1MiID0gImdjb21tOi8vIiBdXQp0aGVuCiAgIFtbICQoaXNfbXlzcWxfcnVubmluZykgLWVxIDAgXV0gJiYga2lsbCAtOSAiJChnZXRfcGlkICRNQVJJQURCX1BJRF9GSUxFICkiCgogICBpbnN0YWxsX21hc3Rlcl9kYgogICBydW5fbXlzcWxfdGVtcF9iZwoKICAgdz0xCiAgIHdoaWxlIFtbICIkKGlzX215c3FsX2FjY2Vzc2libGUpIiA9ICJOT1QgUlVOTklORyIgXV0KICAgZG8KICAgICAgZGlzcGxheV9vdXRwdXQgIiR7WUVMTE9XRk9OVH1XYWl0aW5nIGZvciBNYXJpYWRiIGRhdGFiYXNlIHRvIGJlIGFjY2Vzc2libGUgJCgoIHcgKiA1ICkpIG9mICQoKCAxMCAqIDUgKSkgc2Vjb25kcyIKICAgICAgc2xlZXAgNQogICAgICBbWyAkKGlzX215c3FsX3J1bm5pbmcpIC1uZSAwIF1dICYmIFtbICR3IC1ndCAxMCBdXSAmJiBkaXNwbGF5X291dHB1dCAiJHtSRURGT05UfUVycm9yIHdoZW4gdHJ5aW5nIHRvIHN0YXJ0dXAgdGhlIGRhdGFiYXNlLi4uXG4iICYmIGNhdCAkTUFSSUFEQl9MT0dTX0RJUi9teXNxbGQubG9nICYmIGV4aXQgMQogICAgICB3PSQoKCB3ICsgMSApKQogICBkb25lCgogICBpZiBbWyAkKGlzX215c3FsX3J1bm5pbmcpIC1lcSAwIF1dCiAgIHRoZW4KICAgICAgY3JlYXRlX2RiX2FuZF91c2VyCiAgICAgIGNyZWF0ZV9yZXBsX3VzZXIKICAgICAgY3JlYXRlX2JhY2t1cF91c2VyCiAgIGVsc2UKICAgICAgZGlzcGxheV9vdXRwdXQgIiR7UkVERk9OVH1EYXRhYmFzZSBpcyBub3QgcnVubmluZyEhLi4uIgogICBmaQoKICAgW1sgJChpc19teXNxbF9ydW5uaW5nKSAtZXEgMCBdXSAmJiBzaHV0ZG93bl90bXBfbXlzcWwKICAgW1sgISAtTCAiJHtNQVJJQURCX0xPR1NfRElSfS9teXNxbGQubG9nIiBdXSAmJiBybSAtZiAiJE1BUklBREJfTE9HU19ESVIiL215c3FsZC5sb2cKZmkKCltbICEgLUwgIiR7TUFSSUFEQl9MT0dTX0RJUn0vbXlzcWxkLmxvZyIgXV0gJiYgbG4gLXNmIC9kZXYvc3Rkb3V0ICIkTUFSSUFEQl9MT0dTX0RJUiIvbXlzcWxkLmxvZyAmJiBhZGRncm91cCBteXNxbCB0dHkgJiYgY2hvd24gLWggbXlzcWw6bXlzcWwgIiRNQVJJQURCX0xPR1NfRElSIi9teXNxbGQubG9nCm15c3FsZCAtLXVzZXI9JERCVVNFUiAtLXZlcmJvc2UK" | base64 -d > /usr/local/bin/entrypoint-gmariadb.sh
RUN chmod ugo+x /usr/local/bin/entrypoint-gmariadb.sh
ENTRYPOINT ["/usr/local/bin/entrypoint-gmariadb.sh"]
